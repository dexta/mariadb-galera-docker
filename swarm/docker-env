#!/bin/bash

if [ ! -f ./api-certs/cert.pem ]; then
  echo
  echo "Can't find the api-certs required to connect to the swarm manager api!"
  echo "Please ensure that the following certificats exist in the api-certs folder:"
  echo 
  echo "ca.pem"
  echo "cert.pem"
  echo "key.pem"
  echo
  echo "Note: These are generated by cluster-builder during swarm creation."
  echo
  exit 1
fi

if [ ! -f galera.yml ]; then 
  echo 
  echo "No galera.yml file exists in the current directory"
  echo "See the example galera.yml.example for details."
  exit 1
fi

DOCKER_PORT=`sed -n '/^docker-port:/ {s///p;q;}' galera.yml | xargs`
if [ -z $DOCKER_PORT ]; then
  DOCKER_PORT=2376
fi

export DOCKER_HOST=`sed -n '/^docker-host:/ {s///p;q;}' galera.yml | xargs`:$DOCKER_PORT
export DOCKER_CERT_PATH=./api-certs
export DOCKER_TLS_VERIFY=1

docker $@

